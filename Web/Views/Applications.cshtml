@using Umbraco.Cms.Web.Common.PublishedModels
@using Umbraco.Cms.Core.Security
@using Umbraco.Cms.Core.Services
@using Code.Services
@using Web.ViewModels
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@inject IMemberManager MemberManager
@inject IMemberService MemberService
@inject IApplicationsService ApplicationsService
@{
    Layout = null;

    var currentMember = await MemberManager.GetCurrentMemberAsync();
    ApplicationsViewModel? viewModel = null;
    string memberName = string.Empty;
    bool hasAccess = false;

    if (currentMember != null)
    {
        var data = await ApplicationsService.GetApplicationsForMemberAsync(currentMember.Email!);

        hasAccess = data.IsAdmin || data.IsScheduler;

        if (hasAccess)
        {
            memberName = currentMember.Name ?? currentMember.Email ?? "Bruger";

            viewModel = new ApplicationsViewModel
            {
                MemberName = memberName,
                IsAdmin = data.IsAdmin,
                IsScheduler = data.IsScheduler,
                AllowedCrews = data.AllowedCrews.Select(c => new CrewFilterItemViewModel
                {
                    Id = c.Id,
                    Name = c.Name
                }).OrderBy(c => c.Name).ToList(),
                Applications = data.Applications.Select(a => new ApplicationItemViewModel
                {
                    MemberId = a.MemberId,
                    MemberKey = a.MemberKey,
                    FirstName = a.FirstName,
                    LastName = a.LastName,
                    FullName = a.FullName,
                    Email = a.Email,
                    Phone = a.Phone,
                    Birthdate = a.Birthdate,
                    Age = a.Age,
                    Zipcode = a.Zipcode,
                    TidligereArbejdssteder = a.TidligereArbejdssteder,
                    AcceptedDate = a.AcceptedDate,
                    CrewWishes = a.CrewWishes.Select(w => new CrewWishViewModel
                    {
                        Id = w.Id,
                        Key = w.Key,
                        Name = w.Name,
                        Url = w.Url
                    }).ToList()
                }).ToList()
            };
        }
    }
}
<!DOCTYPE html>
<html lang="da" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ansøgninger - Blue Bridge Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        .bg-blue-bridge { background-color: #23297A; }
        .text-blue-bridge { color: #23297A; }
        .bg-accent-yellow { background-color: #FFF000; }
        .border-blue-bridge { border-color: #23297A; }
    </style>
</head>
<body class="h-full">

@if (currentMember == null)
{
    <!-- Not logged in -->
    <div class="min-h-screen flex items-center justify-center bg-slate-50">
        <div class="text-center">
            <div class="h-12 w-auto bg-blue-bridge flex items-center justify-center text-white font-bold p-2 rounded mx-auto max-w-xs mb-8">
                BLUE BRIDGE <span class="ml-2 font-light text-xs tracking-widest uppercase">Portal</span>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Du skal være logget ind</h2>
            <p class="text-gray-600 mb-6">Log ind for at se ansøgninger</p>
            <a href="/login" class="inline-block bg-accent-yellow text-blue-bridge px-6 py-3 rounded-md font-bold uppercase tracking-wider hover:opacity-90">
                Log ind
            </a>
        </div>
    </div>
}
else if (!hasAccess)
{
    <!-- No access -->
    <div class="min-h-screen flex items-center justify-center bg-slate-50">
        <div class="text-center">
            <div class="h-12 w-auto bg-blue-bridge flex items-center justify-center text-white font-bold p-2 rounded mx-auto max-w-xs mb-8">
                BLUE BRIDGE <span class="ml-2 font-light text-xs tracking-widest uppercase">Portal</span>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Ingen adgang</h2>
            <p class="text-gray-600 mb-6">Du har ikke adgang til at se ansøgninger. Kun administratorer og vagtplanlæggere kan se denne side.</p>
            <a href="/" class="text-blue-bridge hover:opacity-80 font-semibold">Gå til forsiden</a>
        </div>
    </div>
}
else if (viewModel == null)
{
    <!-- Error loading data -->
    <div class="min-h-screen flex items-center justify-center bg-slate-50">
        <div class="text-center">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Der opstod en fejl</h2>
            <p class="text-gray-600 mb-6">Kunne ikke hente ansøgninger. Prøv igen senere.</p>
            <a href="/" class="text-blue-bridge hover:opacity-80 font-semibold">Gå til forsiden</a>
        </div>
    </div>
}
else
{
    @await Html.PartialAsync("Partials/_Navigation")

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Ansøgninger</h1>
                    <p class="mt-2 text-gray-600">
                        @if (viewModel.IsAdmin)
                        {
                            <span>Oversigt over alle nye ansøgninger fra frivillige, der har tilmeldt sig eller accepteret invitationen.</span>
                        }
                        else
                        {
                            <span>Ansøgninger fra frivillige der ønsker at være med i dine crews.</span>
                        }
                    </p>
                </div>
                <div class="flex items-center space-x-2 @(viewModel.IsAdmin ? "bg-amber-50 border-amber-200" : "bg-blue-50 border-blue-200") border rounded-lg px-4 py-2">
                    <svg class="h-5 w-5 @(viewModel.IsAdmin ? "text-amber-600" : "text-blue-600")" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
                    </svg>
                    <span class="text-sm font-medium @(viewModel.IsAdmin ? "text-amber-800" : "text-blue-800")">
                        @(viewModel.IsAdmin ? "Administrator" : "Vagtplanlægger")
                    </span>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white shadow rounded-lg p-4 text-center">
                <div class="text-3xl font-bold text-blue-bridge">@viewModel.Applications.Count</div>
                <div class="text-sm text-gray-600">Nye ansøgninger</div>
            </div>
            <div class="bg-white shadow rounded-lg p-4 text-center">
                <div class="text-3xl font-bold text-green-600">@viewModel.AllowedCrews.Count</div>
                <div class="text-sm text-gray-600">@(viewModel.IsAdmin ? "Crews i alt" : "Dine crews")</div>
            </div>
            <div class="bg-white shadow rounded-lg p-4 text-center">
                <div class="text-3xl font-bold text-amber-600">@viewModel.Applications.Count(a => a.CrewWishes.Any())</div>
                <div class="text-sm text-gray-600">Med crew-ønsker</div>
            </div>
        </div>

        @if (!viewModel.IsAdmin && viewModel.AllowedCrews.Any())
        {
            <!-- Crew Filter Info for Schedulers -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                    <svg class="h-5 w-5 text-blue-600 mt-0.5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                    </svg>
                    <div>
                        <p class="text-sm text-blue-800">
                            Du ser kun ansøgninger fra frivillige, der har ønsket at være i et af dine crews:
                            <span class="font-semibold">@string.Join(", ", viewModel.AllowedCrews.Select(c => c.Name))</span>
                        </p>
                    </div>
                </div>
            </div>
        }

        <!-- Applications List -->
        @if (viewModel.Applications.Any())
        {
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ansøger</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kontakt</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alder</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crew-ønsker</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tilmeldt</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Handling</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            @foreach (var application in viewModel.Applications)
                            {
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="h-10 w-10 rounded-full bg-blue-bridge flex items-center justify-center text-white text-sm font-bold mr-3">
                                                @(application.FirstName.Length > 0 ? application.FirstName[0].ToString().ToUpper() : "?")@(application.LastName.Length > 0 ? application.LastName[0].ToString().ToUpper() : "")
                                            </div>
                                            <div>
                                                <div class="font-medium text-gray-900">@application.FullName</div>
                                                @if (!string.IsNullOrEmpty(application.Zipcode))
                                                {
                                                    <span class="text-xs text-gray-500">@application.Zipcode</span>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-sm text-gray-900">@application.Email</div>
                                        @if (!string.IsNullOrEmpty(application.Phone))
                                        {
                                            <div class="text-sm text-gray-500">@application.Phone</div>
                                        }
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        @if (application.Age.HasValue)
                                        {
                                            <span class="text-sm text-gray-900">@application.Age år</span>
                                        }
                                        else
                                        {
                                            <span class="text-sm text-gray-400">-</span>
                                        }
                                    </td>
                                    <td class="px-6 py-4">
                                        @if (application.CrewWishes.Any())
                                        {
                                            <div class="flex flex-wrap gap-1">
                                                @foreach (var wish in application.CrewWishes)
                                                {
                                                    <a href="@wish.Url" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800 hover:bg-amber-200 transition-colors" title="Gå til @wish.Name for at tildele frivillig">
                                                        @wish.Name
                                                        <svg class="ml-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                                                        </svg>
                                                    </a>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-sm text-gray-400 italic">Ingen ønsker</span>
                                        }
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        @if (application.AcceptedDate.HasValue)
                                        {
                                            <span class="text-sm text-gray-900">@application.AcceptedDate.Value.ToString("d. MMM yyyy", new System.Globalization.CultureInfo("da-DK"))</span>
                                        }
                                        else
                                        {
                                            <span class="text-sm text-gray-400">-</span>
                                        }
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <a href="/frivillig/medlem/@application.MemberKey" class="inline-flex items-center px-3 py-1.5 border border-blue-bridge text-blue-bridge text-sm font-medium rounded-md hover:bg-blue-bridge hover:text-white transition-colors">
                                            Se profil
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Additional Info Section -->
            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Applications with previous experience -->
                @{
                    var withExperience = viewModel.Applications.Where(a => !string.IsNullOrEmpty(a.TidligereArbejdssteder)).ToList();
                }
                @if (withExperience.Any())
                {
                    <div class="bg-white shadow rounded-lg overflow-hidden">
                        <div class="bg-green-600 px-6 py-4">
                            <h3 class="text-lg font-bold text-white">Med tidligere erfaring (@withExperience.Count)</h3>
                        </div>
                        <div class="p-6">
                            <ul class="space-y-3">
                                @foreach (var app in withExperience.Take(5))
                                {
                                    <li class="flex items-start">
                                        <div class="h-8 w-8 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xs font-bold mr-3 flex-shrink-0">
                                            @(app.FirstName.Length > 0 ? app.FirstName[0].ToString().ToUpper() : "?")
                                        </div>
                                        <div>
                                            <div class="font-medium text-gray-900 text-sm">@app.FullName</div>
                                            <div class="text-xs text-gray-500">@app.TidligereArbejdssteder</div>
                                        </div>
                                    </li>
                                }
                            </ul>
                            @if (withExperience.Count > 5)
                            {
                                <p class="mt-4 text-sm text-gray-500">+ @(withExperience.Count - 5) flere med erfaring</p>
                            }
                        </div>
                    </div>
                }

                <!-- Summary by crew wish -->
                @{
                    var crewWishCounts = viewModel.Applications
                        .SelectMany(a => a.CrewWishes)
                        .GroupBy(w => w.Name)
                        .Select(g => new { Name = g.Key, Count = g.Count() })
                        .OrderByDescending(x => x.Count)
                        .ToList();
                }
                @if (crewWishCounts.Any())
                {
                    <div class="bg-white shadow rounded-lg overflow-hidden">
                        <div class="bg-amber-500 px-6 py-4">
                            <h3 class="text-lg font-bold text-white">Ønsker pr. crew</h3>
                        </div>
                        <div class="p-6">
                            <ul class="space-y-3">
                                @foreach (var crew in crewWishCounts.Take(10))
                                {
                                    <li class="flex items-center justify-between">
                                        <span class="text-sm font-medium text-gray-900">@crew.Name</span>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                                            @crew.Count @(crew.Count == 1 ? "ansøger" : "ansøgere")
                                        </span>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <!-- No applications -->
            <div class="bg-white shadow rounded-lg p-12 text-center">
                <svg class="mx-auto h-16 w-16 text-gray-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                </svg>
                <h3 class="mt-6 text-xl font-semibold text-gray-900">Ingen nye ansøgninger</h3>
                <p class="mt-2 text-gray-600">
                    @if (viewModel.IsAdmin)
                    {
                        <span>Der er ingen nye ansøgninger at behandle lige nu.</span>
                    }
                    else
                    {
                        <span>Der er ingen ansøgninger til dine crews lige nu.</span>
                    }
                </p>
                <a href="/frivillig/crews/" class="mt-4 inline-block text-blue-bridge hover:opacity-80 font-semibold">
                    Gå til crews &rarr;
                </a>
            </div>
        }
    </main>

    <!-- Footer -->
    <footer class="bg-slate-100 border-t border-slate-200 mt-12">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="text-sm text-gray-500">
                    &copy; @DateTime.Now.Year Blue Bridge Festival. Alle rettigheder forbeholdes.
                </div>
                <div class="mt-4 md:mt-0 flex space-x-6">
                    <a href="/contact" class="text-sm text-gray-500 hover:text-gray-900">Kontakt</a>
                    <a href="/privacy" class="text-sm text-gray-500 hover:text-gray-900">Privatlivspolitik</a>
                    <a href="/help" class="text-sm text-gray-500 hover:text-gray-900">Hjælp</a>
                </div>
            </div>
        </div>
    </footer>
}

</body>
</html>