@using Umbraco.Cms.Core.Security
@using Umbraco.Cms.Core.Services
@using Umbraco.Cms.Web.Common.PublishedModels
@inject IMemberManager MemberManager
@inject IMemberService MemberService
@inject IMemberGroupService MemberGroupService
@inject Umbraco.Cms.Core.IPublishedContentQuery PublishedContentQuery
@{
    var currentMember = await MemberManager.GetCurrentMemberAsync();
    var currentPath = Context.Request.Path.Value?.ToLowerInvariant() ?? "";

    // Get site settings for navigation
    var siteSettings = PublishedContentQuery.ContentAtRoot()
        .FirstOrDefault(x => x.ContentType.Alias == "bbvSiteSettings") as BbvSiteSettings;

    var navigationItems = siteSettings?.Navigation?.ToList() ?? new List<IPublishedContent>();
    var navigationNotSignedIn = siteSettings?.NavigationNotSignedIn?.ToList() ?? new List<IPublishedContent>();

    // Get member name and check admin/scheduler status if logged in
    string? memberName = null;
    bool isAdminOrScheduler = false;

    if (currentMember != null)
    {
        var member = MemberService.GetByEmail(currentMember.Email!);
        if (member != null)
        {
            var firstName = member.GetValue<string>("firstName");
            var lastName = member.GetValue<string>("lastName");
            if (!string.IsNullOrEmpty(firstName) || !string.IsNullOrEmpty(lastName))
            {
                memberName = $"{firstName} {lastName}".Trim();
            }

            // Check if member is admin or scheduler
            var memberGroups = MemberService.GetAllRoles(member.Id);
            var adminGroupKey = Guid.Parse("99e1edbb-8181-421d-a74b-e66a2f1e1148");
            var schedulerGroupKey = Guid.Parse("e6eef645-b13b-4edb-880b-7b3cdf5b6816");
            var adminGroup = MemberGroupService.GetById(adminGroupKey);
            var schedulerGroup = MemberGroupService.GetById(schedulerGroupKey);

            isAdminOrScheduler = (adminGroup != null && memberGroups.Contains(adminGroup.Name))
                              || (schedulerGroup != null && memberGroups.Contains(schedulerGroup.Name));
        }

        if (string.IsNullOrEmpty(memberName))
        {
            memberName = currentMember.UserName;
        }
    }

    // Helper function to check if a nav item is active
    bool IsActive(IPublishedContent navItem)
    {
        var navUrl = navItem.Url()?.ToLowerInvariant() ?? "";
        if (string.IsNullOrEmpty(navUrl)) return false;

        // Exact match for home/dashboard
        if (navUrl == "/" && (currentPath == "/" || currentPath == ""))
        {
            return true;
        }

        // For other pages, check if current path starts with nav url (but not for root)
        if (navUrl != "/" && currentPath.StartsWith(navUrl.TrimEnd('/')))
        {
            return true;
        }

        return false;
    }
}

@await Html.PartialAsync("Partials/_ImpersonationBanner")

<nav class="bg-blue-bridge shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <a href="/" class="flex items-center text-white font-bold">
                    BLUE BRIDGE <span class="ml-2 font-light text-xs tracking-widest uppercase">frivillig</span>
                </a>
            </div>
            @if (currentMember != null)
            {
                <div class="hidden md:flex items-center space-x-8">
                    @foreach (var navItem in navigationItems)
                    {
                        var isActive = IsActive(navItem);
                        var navUrl = navItem.Url();
                        var navName = navItem.Name;

                        // Check if this is the applications page (requires admin/scheduler)
                        var isApplicationsPage = navItem.ContentType.Alias == "bbvApplications"
                            || navUrl?.ToLowerInvariant().Contains("ansoegninger") == true
                            || navUrl?.ToLowerInvariant().Contains("ansogninger") == true;

                        if (isApplicationsPage && !isAdminOrScheduler)
                        {
                            continue; // Skip applications link for non-admin/scheduler users
                        }

                        <a href="@navUrl" class="@(isActive ? "text-white font-semibold border-b-2 border-white pb-1" : "text-white/80 hover:text-white transition-colors")">@navName</a>
                    }
                </div>
                <div class="flex items-center space-x-4">
                    @if (!string.IsNullOrEmpty(memberName))
                    {
                        <span class="text-white/80 text-sm hidden sm:block">@memberName</span>
                    }
                    <form method="post" action="/umbraco/surface/MemberAuthSurface/HandleLogout" class="inline">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="text-white/80 hover:text-white text-sm font-medium transition-colors">
                            Log ud
                        </button>
                    </form>
                </div>
            }
            else
            {
                <div class="hidden md:flex items-center space-x-8">
                    @foreach (var navItem in navigationNotSignedIn)
                    {
                        var isActive = IsActive(navItem);
                        var navUrl = navItem.Url();
                        var navName = navItem.Name;

                        <a href="@navUrl" class="@(isActive ? "text-white font-semibold border-b-2 border-white pb-1" : "text-white/80 hover:text-white transition-colors")">@navName</a>
                    }
                </div>
                <div class="flex items-center">
                    <a href="/login" class="bg-accent-yellow text-blue-bridge px-4 py-2 rounded-md text-sm font-bold uppercase tracking-wider hover:opacity-90">Log ind</a>
                </div>
            }
        </div>
    </div>
    @if (currentMember != null && navigationItems.Any())
    {
        <!-- Mobile menu (logged in) -->
        <div class="md:hidden border-t border-white/20 px-4 py-3">
            <div class="flex flex-wrap gap-4">
                @foreach (var navItem in navigationItems)
                {
                    var isActive = IsActive(navItem);
                    var navUrl = navItem.Url();
                    var navName = navItem.Name;

                    // Check if this is the applications page (requires admin/scheduler)
                    var isApplicationsPage = navItem.ContentType.Alias == "bbvApplications"
                        || navUrl?.ToLowerInvariant().Contains("ansoegninger") == true
                        || navUrl?.ToLowerInvariant().Contains("ansogninger") == true;

                    if (isApplicationsPage && !isAdminOrScheduler)
                    {
                        continue; // Skip applications link for non-admin/scheduler users
                    }

                    <a href="@navUrl" class="@(isActive ? "text-white font-semibold" : "text-white/80 hover:text-white") text-sm">@navName</a>
                }
            </div>
        </div>
    }
    else if (currentMember == null && navigationNotSignedIn.Any())
    {
        <!-- Mobile menu (not logged in) -->
        <div class="md:hidden border-t border-white/20 px-4 py-3">
            <div class="flex flex-wrap gap-4">
                @foreach (var navItem in navigationNotSignedIn)
                {
                    var isActive = IsActive(navItem);
                    var navUrl = navItem.Url();
                    var navName = navItem.Name;

                    <a href="@navUrl" class="@(isActive ? "text-white font-semibold" : "text-white/80 hover:text-white") text-sm">@navName</a>
                }
            </div>
        </div>
    }
</nav>
