@using Umbraco.Cms.Web.Common.PublishedModels;
@using Web.ViewModels;
@using Code.Services;
@using System.Text.Json;
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<BbvSignUp>
@inject ICrewService CrewService
@{
    Layout = "~/Views/Shared/_MasterLayout.cshtml";

    // Deserialize model from TempData if validation failed
    SignupViewModel formModel = new SignupViewModel();
    var signupModelJson = TempData["SignupModel"] as string;
    if (!string.IsNullOrEmpty(signupModelJson))
    {
        formModel = System.Text.Json.JsonSerializer.Deserialize<SignupViewModel>(signupModelJson) ?? new SignupViewModel();
    }

    var signupError = TempData["SignupError"] as string;

    // Get all available crews for the multi-select
    var crewsData = await CrewService.GetCrewsForMemberAsync("", true);
    var availableCrews = crewsData.Crews.OrderBy(c => c.Name).ToList();
}
<!DOCTYPE html>
<html lang="da" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tilmeld dig - Blue Bridge Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        h1, h2 { font-family: 'Playfair Display', serif; }
        .bg-blue-bridge { background-color: #23297A; }
        .text-blue-bridge { color: #23297A; }
        .bg-accent-yellow { background-color: #FFF000; }
    </style>
</head>
<body class="h-full">

<div class="flex min-h-full">
    <div class="flex flex-1 flex-col justify-center px-4 py-12 sm:px-6 lg:flex-none lg:px-20 xl:px-24 bg-white">
        <div class="mx-auto w-full max-w-md lg:w-[28rem]">
            <div>
                <div class="h-12 w-auto bg-blue-bridge flex items-center justify-center text-white font-bold p-2 rounded">
                    BLUE BRIDGE <span class="ml-2 font-light text-xs tracking-widest uppercase">Portal</span>
                </div>

                <h2 class="mt-8 text-3xl font-bold tracking-tight text-gray-900">Bliv frivillig</h2>
                <p class="mt-2 text-sm text-gray-600">
                    Opret en konto og bliv en del af vores fantastiske frivillig-team.
                </p>
            </div>

            <div class="mt-8">
                @if (!string.IsNullOrEmpty(signupError))
                {
                    <div class="rounded-md bg-red-50 p-4 mb-6">
                        <p class="text-sm text-red-800">@signupError</p>
                    </div>
                }

                <form method="post" action="/umbraco/surface/MemberAuthSurface/HandleSignup" class="space-y-5">
                    @Html.AntiForgeryToken()

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="firstName" class="block text-sm font-medium leading-6 text-gray-900">Fornavn</label>
                            <div class="mt-2">
                                <input id="firstName" name="FirstName" type="text" autocomplete="given-name" required value="@formModel.FirstName"
                                       class="block w-full rounded-md border-0 py-2.5 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-800 sm:text-sm sm:leading-6 px-3">
                            </div>
                        </div>
                        <div>
                            <label for="lastName" class="block text-sm font-medium leading-6 text-gray-900">Efternavn</label>
                            <div class="mt-2">
                                <input id="lastName" name="LastName" type="text" autocomplete="family-name" required value="@formModel.LastName"
                                       class="block w-full rounded-md border-0 py-2.5 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-800 sm:text-sm sm:leading-6 px-3">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-medium leading-6 text-gray-900">Email adresse</label>
                        <div class="mt-2">
                            <input id="email" name="Email" type="email" autocomplete="email" required value="@formModel.Email"
                                   class="block w-full rounded-md border-0 py-2.5 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-800 sm:text-sm sm:leading-6 px-3">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="phone" class="block text-sm font-medium leading-6 text-gray-900">Telefon <span class="text-gray-400 font-normal">(valgfrit)</span></label>
                            <div class="mt-2">
                                <input id="phone" name="Phone" type="tel" autocomplete="tel" value="@formModel.Phone"
                                       class="block w-full rounded-md border-0 py-2.5 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-800 sm:text-sm sm:leading-6 px-3">
                            </div>
                        </div>
                        <div>
                            <label for="zipcode" class="block text-sm font-medium leading-6 text-gray-900">Postnummer <span class="text-gray-400 font-normal">(valgfrit)</span></label>
                            <div class="mt-2">
                                <input id="zipcode" name="Zipcode" type="text" autocomplete="postal-code" maxlength="4" pattern="\d{4}" placeholder="0000" value="@formModel.Zipcode"
                                       class="block w-full rounded-md border-0 py-2.5 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-800 sm:text-sm sm:leading-6 px-3">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="birthdate" class="block text-sm font-medium leading-6 text-gray-900">Fødselsdato <span class="text-gray-400 font-normal">(valgfrit)</span></label>
                        <div class="mt-2">
                            <input id="birthdate" name="Birthdate" type="date" autocomplete="bday" value="@(formModel.Birthdate?.ToString("yyyy-MM-dd"))"
                                   class="block w-full rounded-md border-0 py-2.5 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-800 sm:text-sm sm:leading-6 px-3">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium leading-6 text-gray-900 mb-2">Vælg crew ønsker <span class="text-gray-400 font-normal">(ønsk gerne flere crews, så er der større chance for at vi kan give dig en vagt)</span></label>
                        <div class="max-h-48 overflow-y-auto border border-gray-300 rounded-md p-3 space-y-2">
                            @if (availableCrews.Any())
                            {
                                @foreach (var crew in availableCrews)
                                {
                                    var isChecked = formModel.CrewWishes?.Contains(crew.Id) ?? false;
                                    <div class="flex items-start">
                                        <div class="flex items-center h-5">
                                            <input id="crew_@crew.Id" name="CrewWishes" type="checkbox" value="@crew.Id" @(isChecked ? "checked" : "")
                                                   class="h-4 w-4 rounded border-gray-300 text-blue-800 focus:ring-blue-800">
                                        </div>
                                        <div class="ml-3">
                                            <label for="crew_@crew.Id" class="font-medium text-gray-900 cursor-pointer">@crew.Name</label>
                                            @if (!string.IsNullOrEmpty(crew.Description))
                                            {
                                                <p class="text-xs text-gray-500">@crew.Description</p>
                                            }
                                            @if (crew.AgeLimit.HasValue && crew.AgeLimit.Value > 0)
                                            {
                                                <span class="inline-block text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded mt-1">@crew.AgeLimit+ år</span>
                                            }
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <p class="text-sm text-gray-500 italic">Der er ingen crews tilgængelige i øjeblikket.</p>
                            }
                        </div>
                    </div>

                    <div>
                        <label for="password" class="block text-sm font-medium leading-6 text-gray-900">Adgangskode</label>
                        <div class="mt-2">
                            <input id="password" name="Password" type="password" autocomplete="new-password" required
                                   class="block w-full rounded-md border-0 py-2.5 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-800 sm:text-sm sm:leading-6 px-3">
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Mindst 10 tegn med store/små bogstaver, tal og specialtegn</p>
                    </div>

                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium leading-6 text-gray-900">Bekræft adgangskode</label>
                        <div class="mt-2">
                            <input id="confirmPassword" name="ConfirmPassword" type="password" autocomplete="new-password" required
                                   class="block w-full rounded-md border-0 py-2.5 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-800 sm:text-sm sm:leading-6 px-3">
                        </div>
                    </div>

                    <div class="flex items-start">
                        <div class="flex items-center h-6">
                            <input id="acceptTerms" name="AcceptTerms" type="checkbox" value="true" required
                                   class="h-4 w-4 rounded border-gray-300 text-blue-800 focus:ring-blue-800">
                        </div>
                        <div class="ml-3">
                            <label for="acceptTerms" class="text-sm text-gray-600">
                                Jeg accepterer <a href="#" class="font-semibold text-blue-bridge hover:opacity-80">vilkår og betingelser</a>
                            </label>
                        </div>
                    </div>

                    <div>
                        <button type="submit"
                                class="flex w-full justify-center rounded-md bg-accent-yellow px-3 py-2.5 text-sm font-bold leading-6 text-blue-bridge shadow-sm hover:opacity-90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-yellow-400 uppercase tracking-wider">
                            Opret konto
                        </button>
                    </div>
                </form>

                <p class="mt-8 text-center text-sm text-gray-500">
                    Har du allerede en konto?
                    <a href="/login" class="font-semibold leading-6 text-blue-bridge hover:opacity-80">Log ind her</a>
                </p>
            </div>
        </div>
    </div>

    <div class="relative hidden w-0 flex-1 lg:block">
        <div class="absolute inset-0 bg-blue-bridge opacity-40 mix-blend-multiply z-10"></div>
        <img class="absolute inset-0 h-full w-full object-cover"
             src="https://www.bluebridge.dk/media/d41flw4u/blue-bridge-2025-74-large.jpg?rmode=pad&width=1920&&v=1dc111b53088a10"
             alt="Festival frivillige">

        <div class="absolute inset-0 z-20 flex items-center justify-center p-12 text-white">
            <div class="max-w-md text-center">
                <blockquote class="text-2xl font-serif italic">
                    "Sammen skaber vi den bedste oplevelse."
                </blockquote>
                <p class="mt-4 font-semibold uppercase tracking-widest text-sm">- Blue Bridge Festival</p>
            </div>
        </div>
    </div>
</div>

</body>
</html>
